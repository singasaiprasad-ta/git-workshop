name: Machine_Learning_Workflow
on:
    # Triggers the workflow on push or pull request events but only for the $default-branch 
  push:
    branches: argparser/17

  pull_request:
    branches: main

    # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:  

jobs:
    test_package:
     name: test_package
     runs-on: "ubuntu-latest"
     defaults:
       run:
         shell: bash -el {0}
     steps:     
       - uses: actions/checkout@v4
       - name: Set up Miniconda
         uses: conda-incubator/setup-miniconda@v2
         with: 
           installer-url: https://github.com/conda-forge/miniforge/releases/download/4.8.3-2/Miniforge-pypy3-4.8.3-2-Linux-x86_64.sh
           conda-activation: mle-dev
           environment-file: env.yml
           auto-update-conda : true
           python-version: '3.13.0'
       - run: |
           conda info
           conda list
           conda config --show-sources
           conda config --show
       - name: Install tree
         run: |
              sudo apt install tree
       - name: Display directory tree(before development mode)
         run: |   
            tree    
       - name: test the files under development mode
         run: |
            pip install -e .
            pip install pytest     
            pytest   
       - name: Display directory tree(after development mode)    
         run: |
             tree      
    build_package:
     name: build_package
     needs: test_package
     runs-on: "ubuntu-latest"
     defaults:
       run:
         shell: bash -el {0}
     steps:     
       - uses: actions/checkout@v4
       - name: Set up Miniconda
         uses: conda-incubator/setup-miniconda@v2
         with: 
           installer-url: https://github.com/conda-forge/miniforge/releases/download/4.8.3-2/Miniforge-pypy3-4.8.3-2-Linux-x86_64.sh
           conda-activation: mle-dev
           environment-file: env.yml
           auto-update-conda : true
           python-version: '3.13.0'
       - run: |
           conda info
           conda list
           conda config --show-sources
           conda config --show
       - name: Install tree
         run: |
              sudo apt install tree
       - name: Display directory tree(before build)
         run: |   
            tree         
       - name: Build the package
         run: |
             pip install build
             python -m build
       - name: Display directory tree(after build)    
         run: |
             tree   
       - name: move the env.yml file  to dist folder
         run: |
           mv ./env.yml ./dist    
       - name: move the scripts folder to dist folder
         run: |
             mkdir ./dist/scripts
             mv ./scripts/* ./dist/scripts   
       - name: upload into artifacts
         uses: actions/upload-artifact@v4
         with:
           name: dist
           path: dist/*            

    deploy_package:
      name: deploy_package
      needs: build_package
      runs-on: "ubuntu-latest"
      defaults:
        run:
         shell: bash -el {0}
      steps:   
       - name: Download build artifacts
         uses: actions/download-artifact@v4
         with:
           name: dist
           path: ./dist   
       - name: Disable SSL Verification (if required)
         run: |
             conda config --set ssl_verify no
             
       - name: Set up Miniconda
         uses: conda-incubator/setup-miniconda@v2
         with: 
             installer-url: https://github.com/conda-forge/miniforge/releases/download/4.8.3-2/Miniforge-pypy3-4.8.3-2-Linux-x86_64.sh
             conda-activation: mle-dev
             environment-file: ./dist/env.yml
             auto-update-conda : true
             python-version: '3.13.0'
       - run: |
             conda info
             conda list
             conda config --show-sources
             conda config --show   
       - name: Install tree
         run:  |
           sudo apt install -y tree
           tree    
       - name: Install the package
         run: |
           pip install dist/*.whl

       - name: Run data ingestion script with -h
         run: |
             python dist/scripts/ingest_data.py -h
       - name: Run training script with -h
         run: |
             python dist/scripts/train.py -h
   
       - name: Run scoring script with -h
         run: |
             python dist/scripts/score.py -h    
       - name: Run data ingestion script
         run: |
             python dist/scripts/ingest_data.py --output-path ./datasets/housing             
   
       - name: Train the model
         run: |
             python dist/scripts/train.py --input-path ./datasets/housing/housing.csv --output-path ./models/
   
       - name: Score the model
         run: |
             python dist/scripts/score.py --model-path ./models/best_model.pkl --data-path ./datasets/housing/housing.csv





